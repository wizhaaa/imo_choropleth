<!DOCTYPE html>
<html lang="en"> 
<head>
  <title> World IMO Visual </title>

  <!-- d3 + topojson -->
  <script src="https://d3js.org/d3.v7.min.js"></script> 
  <script src="https://d3js.org/topojson.v3.min.js"></script>
</head>
<body>
  <div id="map"></div>

  <script> 
    async function createMap() { 
      const width = 1440;
      const height = 900;

      const svg = d3.select('#map')
        .append('svg')
        .attr('width', width)
        .attr('height', height);
      
      const colorScale = d3.scaleSequential(d3.interpolateYlOrRd).domain([0, 100]);
      const tooltip = d3.select('body').append('div')
        .attr('class', 'tooltip');

      const imo_data = await d3.csv('country_imo_results.csv');
      const world_data = await d3.json('countries-110m.json');

      
      imo_data.forEach(d=> {
        if (d.country === "People's Republic of China") d.country = 'China'; 
        else if (d.country === "Russian Federation") d.country = 'Russia';
        else if (d.country === "Islamic Republic of Iran") d.country = 'Iran';
        else if (d.country === "TÃ¼rkiye") d.country = 'Turkey';
        else if (d.country === "Czech Republic") d.country = 'Czechia';
        else if (d.country === "Bosnia and Herzegovina") d.country = 'Bosnia and Herz.';
        else if (d.country === "Republic of Moldova") d.country = 'Moldova';
        else if (d.country === "North Macedonia") d.country = 'Macedonia';
        else if (d.country === "Republic of Korea") d.country = 'South Korea';

      })
      
      
      
      const countries = topojson.feature(world_data, world_data.objects.countries);

      const projection = d3.geoMercator().fitSize([width, height], countries);
      
      const path = d3.geoPath().projection(projection);
      // imo data => get total medal count per country 
      const medalCountMap = new Map();
      imo_data.forEach(d => { 
        const country = d.country;
        const medals = +d.awards_gold + +d.awards_silver + +d.awards_bronze;
        medalCountMap.set(country, (medalCountMap.get(country) || 0 ) + medals);
      })
      // max medal count 
      const maxMedalCount = Math.max(...medalCountMap.values());
      colorScale.domain([0, maxMedalCount]);
      console.log(medalCountMap)

      console.log(countries.features);
      svg.selectAll('path')
        .data(countries.features)
        .enter()
        .append('path')
        .attr('d', path)
        .attr('class', 'country')
        .attr('fill', d => {
          const medalCount = medalCountMap.get(d.properties.name);
          return medalCount ? colorScale(medalCount) : '#ccc';
        })
      
    }
    createMap();
  </script>


</body>
</html>